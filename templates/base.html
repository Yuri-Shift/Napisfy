{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="cache-control" content="max-age=604800" />
    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/logo.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'img/logo.png' %}" type="image/x-icon">

    <title>Napisfy - Tela Inicial</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>

<body class="bg-dark text-light">
    {% include 'includes/navbar.html' %}

    {% include 'includes/sidebar.html' %}

    {% block content %}
    {% endblock %}

    {% include 'includes/footer.html' %}

    <!-- JavaScript deve vir no final do body -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="{% static 'js/jquery-3.7.0.min.js' %}"></script>
    <!-- Howler.js for audio playback -->
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
    <!-- Custom JS -->
    <script src="{% static 'js/music-player.js' %}"></script>

    <script>
        // DOM Ready
        document.addEventListener('DOMContentLoaded', function () {
            // Login Modal
            const loginModalElement = document.getElementById('loginModal');
            const loginModal = loginModalElement ? new bootstrap.Modal(loginModalElement) : null;
            const profileButton = document.getElementById('profile-button');

            if (profileButton && loginModal) {
                profileButton.addEventListener('click', () => loginModal.show());
            }

            // jQuery ready
            $(document).ready(function () {
                // jQuery code aqui
                console.log('jQuery carregado e DOM pronto');

                // Initialize music player after a short delay
                setTimeout(() => {
                    if (window.musicPlayer) {
                        console.log('Music Player with Howler.js is ready!');

                        // Add keyboard shortcut info
                        console.log('Keyboard shortcuts:');
                        console.log('- Spacebar: Play/Pause');
                        console.log('- Left Arrow: Skip backward 10s');
                        console.log('- Right Arrow: Skip forward 10s');
                        console.log('- Up Arrow: Volume up');
                        console.log('- Down Arrow: Volume down');
                        
                        // Carregar m√∫sicas do Django automaticamente
                        initPlayerWithDjangoData();
                    }
                }, 1000);
            });
        });

        async function playTrackFromDB(trackId) {
            try {
                console.log('üéµ Carregando m√∫sica ID:', trackId);
                
                // Buscar detalhes da m√∫sica via API
                const response = await fetch(`/api/cancao/${trackId}/`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar m√∫sica');
                }
                
                const trackData = await response.json();
                console.log('üéµ M√∫sica carregada:', trackData);
                
                // Verificar se tem URL de √°udio
                if (!trackData.url || trackData.url === '') {
                    console.warn('‚ö†Ô∏è M√∫sica sem URL de √°udio:', trackData);
                    showErrorMessage('Esta m√∫sica n√£o tem arquivo de √°udio cadastrado.');
                    return;
                }
                
                console.log('üéµ URL do √°udio:', trackData.url);
                
                // Tocar a m√∫sica
                if (window.musicPlayer) {
                    window.musicPlayer.playTrack(trackData);
                    showPlayer();
                } else {
                    console.error('‚ùå Player n√£o est√° dispon√≠vel');
                    showErrorMessage('Player n√£o est√° dispon√≠vel. Recarregue a p√°gina.');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar m√∫sica:', error);
                showErrorMessage('Erro ao carregar a m√∫sica. Tente novamente.');
            }
        }

        // Fun√ß√£o para tocar todas as m√∫sicas de um √°lbum
        async function playAlbumFromDB(albumId) {
            try {
                console.log('üéµ Carregando √°lbum ID:', albumId);
                
                // Buscar m√∫sicas do √°lbum via API
                const response = await fetch(`/api/album/${albumId}/cancoes/`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar √°lbum');
                }
                
                const albumData = await response.json();
                console.log('üéµ √Ålbum carregado:', albumData);
                
                if (albumData.tracks && albumData.tracks.length > 0) {
                    // Carregar playlist com as m√∫sicas do √°lbum
                    if (window.musicPlayer) {
                        window.musicPlayer.loadPlaylist(albumData.tracks);
                        window.musicPlayer.playTrack(albumData.tracks[0]);
                        showPlayer();
                    }
                } else {
                    showErrorMessage('Este √°lbum n√£o cont√©m m√∫sicas.');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar √°lbum:', error);
                showErrorMessage('Erro ao carregar o √°lbum. Tente novamente.');
            }
        }

        // Fun√ß√£o para carregar todas as m√∫sicas dispon√≠veis
        async function loadAllTracks() {
            try {
                console.log('üéµ Carregando todas as m√∫sicas...');
                
                // Buscar todas as m√∫sicas via API
                const response = await fetch('/api/cancoes/');
                if (!response.ok) {
                    throw new Error('Erro ao carregar m√∫sicas');
                }
                
                const data = await response.json();
                console.log('üéµ Resposta da API:', data);
                console.log('üéµ M√∫sicas carregadas:', data.tracks.length);
                
                if (data.tracks && data.tracks.length > 0) {
                    // Verificar quais m√∫sicas t√™m URL de √°udio
                    const tracksWithAudio = data.tracks.filter(track => track.url && track.url !== '');
                    const tracksWithoutAudio = data.tracks.filter(track => !track.url || track.url === '');
                    
                    console.log(`üéµ M√∫sicas com √°udio: ${tracksWithAudio.length}`);
                    console.log(`‚ö†Ô∏è M√∫sicas sem √°udio: ${tracksWithoutAudio.length}`);
                    
                    if (tracksWithoutAudio.length > 0) {
                        console.warn('‚ö†Ô∏è M√∫sicas sem √°udio:', tracksWithoutAudio);
                    }
                    
                    // Carregar playlist com todas as m√∫sicas
                    if (window.musicPlayer) {
                        window.musicPlayer.loadPlaylist(data.tracks);
                    }
                    
                    return data.tracks;
                } else {
                    showErrorMessage('Nenhuma m√∫sica encontrada no banco de dados.');
                    return [];
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar m√∫sicas:', error);
                showErrorMessage('Erro ao carregar as m√∫sicas. Tente novamente.');
                return [];
            }
        }

        // Fun√ß√£o para inicializar o player com dados do Django
        async function initPlayerWithDjangoData() {
            try {
                console.log('üéµ Inicializando player com dados do Django...');
                
                // Carregar todas as m√∫sicas dispon√≠veis
                const tracks = await loadAllTracks();
                
                if (tracks.length > 0) {
                    console.log(`üéµ Player inicializado com ${tracks.length} m√∫sicas`);
                    showPlayer();
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma m√∫sica encontrada no banco de dados');
                    console.log('üí° Execute: python manage.py populate_db');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar player:', error);
            }
        }

        // Fun√ß√£o para testar player com dados do Django
        async function testPlayer() {
            console.log('üéµ Testando player com dados do Django...');
            
            // Tentar tocar a primeira m√∫sica do banco de dados
            try {
                const tracks = await loadAllTracks();
                if (tracks.length > 0) {
                    window.musicPlayer.playTrack(tracks[0]);
                    console.log('üéµ Tocando primeira m√∫sica do banco:', tracks[0].name);
                    showPlayer();
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma m√∫sica encontrada. Execute: python manage.py populate_db');
                    // Fallback para teste com √°udio de exemplo
                    if (window.musicPlayer) {
                        const testTrack = {
                            id: 'test-1',
                            name: 'Teste de √Åudio',
                            artist: 'Sistema',
                            album: 'Teste',
                            url: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            format: ['wav'],
                            cover: 'https://via.placeholder.com/300x300?text=Teste',
                            duration: 5
                        };
                        window.musicPlayer.playTrack(testTrack);
                        showPlayer();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
            }
        }

        // Fun√ß√£o para buscar e tocar m√∫sicas
        async function searchAndPlay(query) {
            try {
                console.log('üîç Buscando:', query);
                
                // Carregar todas as m√∫sicas e filtrar
                const allTracks = await loadAllTracks();
                const filteredTracks = allTracks.filter(track => 
                    track.name.toLowerCase().includes(query.toLowerCase()) ||
                    track.artist.toLowerCase().includes(query.toLowerCase()) ||
                    track.album.toLowerCase().includes(query.toLowerCase())
                );
                
                if (filteredTracks.length > 0 && window.musicPlayer) {
                    window.musicPlayer.loadPlaylist(filteredTracks);
                    window.musicPlayer.playTrack(filteredTracks[0]);
                    showPlayer();
                } else {
                    showErrorMessage('Nenhuma m√∫sica encontrada para: ' + query);
                }
                
            } catch (error) {
                console.error('‚ùå Erro na busca:', error);
                showErrorMessage('Erro na busca. Tente novamente.');
            }
        }

        // Fun√ß√£o para mostrar mensagens de erro
        function showErrorMessage(message) {
            // Criar uma notifica√ß√£o simples
            const notification = document.createElement('div');
            notification.className = 'alert alert-danger position-fixed';
            notification.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                animation: fadeIn 0.3s ease-in;
            `;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>${message}</span>
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remover automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Fun√ß√£o para mostrar o player
        function showPlayer() {
            const musicPlayer = document.getElementById('musicPlayer');
            if (musicPlayer) {
                musicPlayer.style.display = 'block';
                console.log('üéµ Player exibido');
            }
        }

        // Fun√ß√£o para ocultar o player
        function hidePlayer() {
            const musicPlayer = document.getElementById('musicPlayer');
            if (musicPlayer) {
                musicPlayer.style.display = 'none';
                console.log('üéµ Player ocultado');
            }
        }

        // Fun√ß√£o para alternar visibilidade do player
        function togglePlayer() {
            const musicPlayer = document.getElementById('musicPlayer');
            if (musicPlayer) {
                const isVisible = musicPlayer.style.display !== 'none';
                musicPlayer.style.display = isVisible ? 'none' : 'block';
                console.log('üéµ Player', isVisible ? 'ocultado' : 'exibido');
            }
        }
        
        // Fun√ß√£o para diagnosticar problemas
        async function diagnosticPlayer() {
            console.log('üîç === DIAGN√ìSTICO DO PLAYER ===');
            
            // 1. Verificar se o player est√° carregado
            console.log('1. Player dispon√≠vel:', !!window.musicPlayer);
            
            // 2. Verificar se as APIs est√£o funcionando
            try {
                const response = await fetch('/api/cancoes/');
                console.log('2. API /api/cancoes/ status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('3. Total de m√∫sicas na API:', data.tracks.length);
                    
                    if (data.tracks.length > 0) {
                        console.log('4. Primeira m√∫sica:', data.tracks[0]);
                        console.log('5. URL da primeira m√∫sica:', data.tracks[0].url);
                        
                        // Verificar se existe √°udio para reproduzir
                        const tracksWithAudio = data.tracks.filter(t => t.url && t.url !== '');
                        console.log('6. M√∫sicas com URL de √°udio:', tracksWithAudio.length);
                        
                        if (tracksWithAudio.length === 0) {
                            console.error('‚ùå PROBLEMA: Nenhuma m√∫sica tem URL de √°udio!');
                            console.log('üí° Solu√ß√£o: Adicione arquivos de √°udio ou links nas m√∫sicas no admin');
                        }
                    }
                } else {
                    console.error('‚ùå PROBLEMA: API n√£o est√° respondendo corretamente');
                }
            } catch (error) {
                console.error('‚ùå PROBLEMA: Erro ao acessar API:', error);
            }
            
            // 3. Verificar elementos do DOM
            const playerElement = document.getElementById('musicPlayer');
            console.log('7. Elemento player encontrado:', !!playerElement);
            
            if (playerElement) {
                console.log('8. Player vis√≠vel:', playerElement.style.display !== 'none');
            }
            
            console.log('üîç === FIM DO DIAGN√ìSTICO ===');
        }
        
        // Executar diagn√≥stico automaticamente ap√≥s carregar
        setTimeout(() => {
            diagnosticPlayer();
        }, 3000);
        
        // Adicionar fun√ß√£o global para diagn√≥stico manual
        window.diagnosticPlayer = diagnosticPlayer;
    </script>
</body>

</html>